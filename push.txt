param(
  [string]$Message = "deploy 10.28",
  [string]$CustomDomain = "hprtest.online"
)

$ErrorActionPreference = "Stop"

cmd /c build.bat

$CnamePath = "site/CNAME"
New-Item -ItemType File -Force -Path $CnamePath | Out-Null
Set-Content -Path $CnamePath -NoNewline -Value $CustomDomain

if (!(Test-Path "site/.nojekyll")) {
  New-Item -ItemType File -Path "site/.nojekyll" | Out-Null
}

git add -A
git commit -m $Message
git push origin main

git branch -D gh-pages-tmp 2>$null
git subtree split --prefix=site HEAD -b gh-pages-tmp
git push -f origin gh-pages-tmp:gh-pages
git branch -D gh-pages-tmp
